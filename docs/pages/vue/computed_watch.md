---
title: computedå’Œwatch
outline: deep
date: 2022-02-16
tags: vue
sidebar: true
---

# computed å’Œ watch

## 1. åŸºæœ¬æ¦‚å¿µ(computed/watch)

**computedï¼ˆè®¡ç®—å±æ€§ï¼‰**

- ç‰¹ç‚¹ï¼šåŸºäºä¾èµ– è‡ªåŠ¨ç¼“å­˜ï¼Œåªæœ‰ä¾èµ–çš„æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶æ‰ä¼šé‡æ–°è®¡ç®—ã€‚
- é€‚åˆåœºæ™¯ï¼šç”¨äºä»å·²æœ‰æ•°æ®ä¸­ æ´¾ç”Ÿå‡ºæ–°æ•°æ®ã€‚

**watchï¼ˆä¾¦å¬å™¨ï¼‰**

- ç‰¹ç‚¹ï¼šç”¨äºåœ¨æ•°æ®å˜åŒ–æ—¶ æ‰§è¡Œå‰¯ä½œç”¨é€»è¾‘ï¼ˆè€Œä¸ä»…ä»…æ˜¯è®¡ç®—å€¼ï¼‰ã€‚æ²¡æœ‰ç¼“å­˜ï¼Œæ¯æ¬¡ä¾èµ–æ•°æ®å˜åŒ–éƒ½ä¼šè§¦å‘å›è°ƒã€‚æ”¯æŒå¼‚æ­¥æ“ä½œã€å‰¯ä½œç”¨é€»è¾‘ã€‚å¯è§‚æµ‹å¤šä¸ªæ•°æ®æºã€‚
- é€‚åˆåœºæ™¯ï¼šéœ€è¦åœ¨æ•°æ®å˜åŒ–æ—¶æ‰§è¡Œ å¼‚æ­¥æ“ä½œã€æ—¥å¿—ã€DOM æ“ä½œã€æ‰‹åŠ¨è®¡ç®— ç­‰ã€‚

### ä¸¤è€…çš„åŒºåˆ«

| åŠŸèƒ½ç‚¹                               | `computed`                 | `watch`                          |
| ------------------------------------ | -------------------------- | -------------------------------- |
| **æ•°æ®æ´¾ç”Ÿ**                         | âœ… é€‚åˆ                    | âŒ ä¸æ¨è                        |
| **å‰¯ä½œç”¨ï¼ˆæ—¥å¿—ã€API è°ƒç”¨ã€å®šæ—¶å™¨ï¼‰** | âŒ ä¸é€‚åˆ                  | âœ… å¿…é¡»ç”¨                        |
| **æ˜¯å¦æœ‰ç¼“å­˜**                       | âœ… æœ‰ç¼“å­˜                  | âŒ æ— ç¼“å­˜                        |
| **å¸¸è§åœºæ™¯**                         | è¡¨å•è®¡ç®—ã€ç­›é€‰ã€æ ¼å¼åŒ–æ—¥æœŸ | è¯·æ±‚ APIã€æ·±åº¦ç›‘å¬å¯¹è±¡ã€è°ƒè¯•æ—¥å¿— |

### watch çš„é«˜çº§ç”¨æ³•

#### watch æ·±åº¦ç›‘å¬

é»˜è®¤ç›‘å¬æ˜¯æµ…å±‚çš„ï¼Œå¦‚æœè¦ç›‘å¬å¯¹è±¡å†…éƒ¨å±æ€§ï¼Œéœ€è¦å¼€å¯ deepï¼š

```js
const obj = ref({ count: 0 });

watch(
  obj,
  (newVal, oldVal) => {
    console.log("å˜åŒ–äº†", newVal);
  },
  { deep: true } // å¼€å¯æ·±åº¦ç›‘å¬
);
```

#### watch ç«‹å³æ‰§è¡Œ

é»˜è®¤æƒ…å†µä¸‹ï¼Œwatch ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œåªæœ‰åœ¨ç›‘å¬çš„æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶æ‰ä¼šæ‰§è¡Œã€‚å¦‚æœè¦ç«‹å³æ‰§è¡Œï¼Œå¯ä»¥è®¾ç½® immediate ä¸º trueï¼š

```js
watch(
  obj,
  (newVal, oldVal) => {
    console.log("å˜åŒ–äº†", newVal);
  },
  {
    deep: true, // å¼€å¯æ·±åº¦ç›‘å¬
    immediate: true, // ç«‹å³æ‰§è¡Œ
  }
);
```

#### watch æ‰§è¡Œæ—¶æœº

é»˜è®¤æƒ…å†µä¸‹ï¼Œwatch çš„å›è°ƒå‡½æ•°ä¼šåœ¨ç»„ä»¶æ›´æ–°ä¹‹å‰æ‰§è¡Œã€‚å¦‚æœéœ€è¦åœ¨ç»„ä»¶æ›´æ–°ä¹‹åæ‰§è¡Œï¼Œå¯ä»¥è®¾ç½® flush ä¸º 'post'ï¼š

```js
watch(
  obj,
  (newVal, oldVal) => {
    console.log("å˜åŒ–äº†", newVal);
  },
  {
    deep: true, // å¼€å¯æ·±åº¦ç›‘å¬
    immediate: true, // ç«‹å³æ‰§è¡Œ
    flush: "pre", // åœ¨ ç»„ä»¶æ›´æ–°ä¹‹å‰ æ‰§è¡Œï¼ˆæŠŠå˜æ›´åˆå¹¶è¿›å³å°†å‘ç”Ÿçš„æ¸²æŸ“ï¼‰
    // flush: "pre", //  post åœ¨ DOM å·²æ›´æ–°ä¹‹å æ‰§è¡Œï¼ˆé€‚åˆè¯»/æµ‹é‡ DOMï¼‰ã€‚
    // flush: "sync", //  sync ç«‹å³åŒæ­¥æ‰§è¡Œï¼ˆé©¬ä¸Šè¿è¡Œï¼Œä¸æ’é˜Ÿï¼›è°¨æ…ä½¿ç”¨ï¼Œæ˜“äº§ç”Ÿå¾ªç¯/æ€§èƒ½é—®é¢˜ï¼‰ã€‚
  }
);
```

#### watch æ¸…é™¤å‰¯ä½œç”¨

åœ¨ watch ä¸­ï¼Œå¦‚æœéœ€è¦æ¸…é™¤å‰¯ä½œç”¨ï¼Œå¯ä»¥ä½¿ç”¨ onCleanup å‡½æ•°ï¼š

```js
const keyword = ref("");
let timer = null;

watch(keyword, (newVal, oldVal, onCleanup) => {
  console.log("å…³é”®è¯å˜äº†:", newVal);

  // æ¨¡æ‹Ÿå‰¯ä½œç”¨ï¼šå¼€å¯ä¸€ä¸ªå®šæ—¶å™¨
  timer = setInterval(() => {
    console.log("æ­£åœ¨æœç´¢ï¼š", newVal);
  }, 1000);

  // æ¸…é™¤å‰¯ä½œç”¨
  onCleanup(() => {
    clearInterval(timer);
    console.log("å®šæ—¶å™¨æ¸…é™¤äº†");
  });
});
```

:::tip ğŸ”” å…³é”®ç‚¹

1. onCleanup åªåœ¨ä¸‹ä¸€æ¬¡è§¦å‘ watch å›è°ƒæ—¶æ‰§è¡Œã€‚

- ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶ä¸ä¼šæ¸…ç†ã€‚

- å½“ä¾èµ–å€¼å†æ¬¡æ”¹å˜æ—¶ï¼Œå…ˆæ‰§è¡Œä¸Šä¸€æ¬¡çš„æ¸…ç†é€»è¾‘ï¼Œå†æ‰§è¡Œæ–°çš„å›è°ƒã€‚

2. é¿å…é‡å¤å‰¯ä½œç”¨

- ä¸æ¸…ç†çš„è¯ï¼Œæ¯æ¬¡æ•°æ®å˜æ›´éƒ½ä¼šäº§ç”Ÿæ–°çš„å®šæ—¶å™¨ / ç›‘å¬å™¨ï¼Œæœ€ç»ˆå¯èƒ½å†…å­˜æ³„æ¼ã€‚
  :::

#### watch ç›‘å¬å¤šä¸ªæ•°æ®æº

watch å¯ä»¥ç›‘å¬å¤šä¸ªæ•°æ®æºï¼Œåªéœ€è¦å°†å®ƒä»¬æ”¾åœ¨ä¸€ä¸ªæ•°ç»„ä¸­å³å¯ï¼š

```js
const firstName = ref("Tom");
const lastName = ref("Hanks");

watch([firstName, lastName], ([newF, newL], [oldF, oldL]) => {
  console.log(`æ–°å€¼: ${newF} ${newL}`);
  console.log(`æ—§å€¼: ${oldF} ${oldL}`);
});
```

:::tip ğŸ“¢ æ³¨æ„

ç›‘å¬å¤šä¸ªå“åº”å¼æ•°æ®ï¼Œå›è°ƒå‚æ•°æ˜¯ æ•°ç»„å½¢å¼çš„æ–°å€¼å’Œæ—§å€¼ã€‚

ä»»æ„ä¸€ä¸ªæ”¹å˜ï¼Œå›è°ƒéƒ½ä¼šæ‰§è¡Œã€‚
:::

### watchEffect

vue3 æä¾›äº† watchEffect å‡½æ•°ï¼Œé‚£ä¹ˆ watch å’Œ watchEffect æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ
:::info ğŸ‘‰

**watch**  
éœ€è¦æŒ‡å®šç›‘å¬çš„æ•°æ®ã€‚  
å›è°ƒé‡Œå¯ä»¥æ‹¿åˆ° æ–°å€¼ / æ—§å€¼ã€‚  
é»˜è®¤ ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè¦ç­‰ä¾èµ–å˜äº†æ‰è·‘.

**watchEffect**  
ä¸éœ€è¦æŒ‡å®šç›‘å¬çš„æ•°æ®, å®ƒä¼šè‡ªåŠ¨æ”¶é›†å›è°ƒé‡Œç”¨åˆ°çš„ä¾èµ–ã€‚  
å›è°ƒä¼š ç«‹å³æ‰§è¡Œä¸€æ¬¡ï¼Œä¹‹åä¾èµ–å˜åŒ–æ—¶å†æ‰§è¡Œã€‚  
æ‹¿ä¸åˆ°æ—§å€¼ï¼ˆå› ä¸ºå®ƒä¸å…³å¿ƒâ€œå‰åå·®å¼‚â€ï¼Œåªå…³å¿ƒâ€œä¾èµ–å˜äº†å°±è·‘â€ï¼‰ã€‚
:::

| ç‰¹æ€§             | `watch`                                  | `watchEffect`                        |
| ---------------- | ---------------------------------------- | ------------------------------------ |
| **ä¾èµ–æŒ‡å®š**     | è¦æ‰‹åŠ¨æŒ‡å®š                               | è‡ªåŠ¨æ”¶é›†ï¼ˆå›è°ƒé‡Œç”¨åˆ°å•¥å°±ç›¯å•¥ï¼‰       |
| **æ˜¯å¦ç«‹å³æ‰§è¡Œ** | é»˜è®¤ä¸ç«‹å³ï¼ˆå¯åŠ  `{ immediate: true }`ï¼‰ | ä¼šç«‹å³æ‰§è¡Œä¸€æ¬¡                       |
| **èƒ½å¦æ‹¿æ—§å€¼**   | âœ… å¯ä»¥ `(newVal, oldVal)`               | âŒ ä¸æ”¯æŒ                            |
| **å¸¸è§ç”¨é€”**     | ç²¾å‡†ç›‘å¬æŸä¸ªçŠ¶æ€ï¼Œæ‹¿æ–°æ—§å€¼åšé€»è¾‘         | å“åº”å¼å‰¯ä½œç”¨ï¼ˆæ—¥å¿—ã€è°ƒè¯•ã€DOM æ“ä½œï¼‰ |

## æºç è§£æ

### watch æºç 

ä»£ç å‚è€ƒï¼š[https://github.com/vuejs/core/blob/main/packages/runtime-core/src/apiWatch.ts](https://github.com/vuejs/core/blob/main/packages/runtime-core/src/apiWatch.ts)

åœ¨è¯¥å‡½æ•°ä¸­ï¼Œæ¥å—ä¸‰ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼š`source` ä¾¦å¬çš„æ•°æ®æºï¼Œ`cb` å›è°ƒå‡½æ•°ï¼Œ`options` ä¾¦å¬é€‰é¡¹ã€‚
`watch` å‡½æ•°æœ€ç»ˆéƒ½è°ƒç”¨äº† `doWatch` å‡½æ•°ã€‚

**source** : å¯ä»¥æ˜¯ä¸€ä¸ª `ref` ç±»å‹çš„æ•°æ®ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªå…·æœ‰è¿”å›å€¼çš„ `getter` å‡½æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå“åº”å¼çš„ `obj` å¯¹è±¡ã€‚å½“ä¾¦å¬çš„æ˜¯å¤šä¸ªæºæ—¶ï¼Œ`source` å¯ä»¥æ˜¯ä¸€ä¸ªæ•°ç»„ã€‚

**cb** : å›è°ƒå‡½æ•°ï¼Œå½“ä¾¦å¬çš„æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šæ‰§è¡Œè¯¥å›è°ƒå‡½æ•°ã€‚

**options** : ä¾¦å¬é€‰é¡¹ï¼Œå¯ä»¥è®¾ç½® `immediate`ã€`deep`ã€`flush`ã€`onTrack`ã€`onTrigger` ç­‰å±æ€§ã€‚

æºç å…¥å£

```ts
export function watch(source, cb, options?) {
  return doWatch(source, cb, options);
}
```

æ ¸å¿ƒé€»è¾‘ doWatch (ç®€åŒ–ç‰ˆ)

```js
function doWatch(source, cb, options = {}) {
  // 1. æŠŠ source (ref/reactive/å‡½æ•°/æ•°ç»„)è§„èŒƒæˆ getter
  let getter = createGetterFromSource(source, options);

  // 2. å¦‚æœ deepï¼Œåˆ™æŠŠ getter åŒ…æˆ traverse(getter())
  if (cb && options.deep) {
    const base = getter;
    getter = () => traverse(base());
  }

  // 3. ä¿å­˜ oldValue, cleanup
  let oldValue = INITIAL;
  let cleanup;
  function onCleanup(fn) {
    cleanup = fn;
  }

  // 4. jobï¼šä¾èµ–å˜åŒ–åè¦åšçš„äº‹
  const job = () => {
    const newValue = effect.run(); // é‡æ–°è¿è¡Œ getterï¼Œæ”¶é›†ä¾èµ–
    if (options.deep || hasChanged(newValue, oldValue)) {
      if (cleanup) cleanup(); // æ‰§è¡Œä¸Šä¸€æ¬¡çš„æ¸…ç†
      cb(newValue, oldValue === INITIAL ? undefined : oldValue, onCleanup);
      oldValue = newValue;
    }
  };

  // 5. æ ¹æ® flush åˆ›å»º schedulerï¼ˆsync / pre(default) / postï¼‰
  const scheduler = chooseScheduler(options.flush, job);

  // 6. åˆ›å»º effect
  const effect = new ReactiveEffect(getter, scheduler);

  // 7. å¯åŠ¨ï¼šimmediate ? job() : oldValue = effect.run()
  if (options.immediate) job();
  else oldValue = effect.run();

  // 8. è¿”å› stop
  return () => effect.stop();
}
```

### æ€»ç»“

`watch` çš„æ ¸å¿ƒå°±æ˜¯æŠŠç”¨æˆ·ä¼ å…¥çš„å„ç§ `sourceï¼ˆref/reactive/å‡½æ•°/æ•°ç»„`ï¼‰ç»Ÿä¸€åŒ…è£…æˆä¸€ä¸ª `getter` å‡½æ•°ï¼ŒæŠŠè¿™ä¸ª `getter` æ”¾åˆ°ä¸€ä¸ª `ReactiveEffect` é‡Œè¿è¡Œä»¥æ”¶é›†ä¾èµ–ï¼Œå¹¶ä¸”åœ¨ä¾èµ–å˜åŒ–æ—¶è°ƒç”¨ `effect.scheduler()`ï¼Œscheduler å†³å®šä½•æ—¶æŠŠ job æ’å…¥é˜Ÿåˆ—ï¼ˆsync/pre/postï¼‰,ç„¶åæ‰§è¡Œ job æ‹¿åˆ° `newValue`ï¼Œä¸ `oldValue` æ¯”è¾ƒåå†³å®šæ˜¯å¦è°ƒç”¨ç”¨æˆ·çš„å›è°ƒï¼ˆåŒæ—¶å¤„ç† `cleanupã€immediateã€flushã€deep` ç­‰é€‰é¡¹ï¼‰ã€‚
